<!DOCTYPE html>
<html>
<!-- dit is een test -->
<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/material-kit.css"/>
    <link rel="stylesheet" href="css/default.css" />

    <title>Arduino Project</title>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-success navbar-transparent navbar-color-on-scroll navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">Arduino Project</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#"><i class="material-icons">home</i>Home</a></li>
                    <li><a href="#scope"><i class="material-icons">description</i>Opdracht</a></li>
                    <li><a href="#update"><i class="material-icons">update</i>Updates</a></li>
                    <li><a href="#download"><i class="material-icons">file_download</i>Download</a></li>
                    <li><a href="#code"><i class="material-icons">code</i>Code & Schema</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Content -->
    <div class="jumbotron">
        <h1>Arduino Project</h1>
    </div>
    <div class="container content">
        <!-- Opdracht -->
        <h2 id="scope"><i class="material-icons">description</i> Opdracht</h2>
        <div class="alert">
            <p>
                
                Voor het vak Embedded Systems moeten wij aan de hand van een Arduino bordje zelf een uitgezochte opdracht uitwerken. Je kan elke update volgen met bijhorende foto's.
            </p>
            <p>
                Als project ga ik een lichtsensor en een temperatuur sensor uitlezen.
                De gegevens die ik uitlees ga ik op een webapp of android applicatie uitschrijven.
                Het uitschrijven gebeurt aan de hand van grafieken. Ook moet het mogelijk zijn
                om de huidige waarde te kunnen lezen in waarden. Aan de arduino zelf zal er een
                lcd scherm aangesloten zijn waar je rechtstreeks de huidige waarden kan bekijken.
            </p>
            <p>
                Met vriendelijke groeten,<br>
                Jeroen
            </p>
            <div class="progress">
                <div class="progress-bar progress-bar-success progress-bar-striped"       
                     data-toggle="Complete" data-placement="top" title="100% Complete"
                     style="width: 100%">
                    <span class="sr-only">Complete</span>
                </div>
                <div class="progress-bar progress-bar-warning progress-bar-striped"
                     data-toggle="InProgress" data-placement="top" title="0% In Progress"
                     style="width: 0%">
                    <span class="sr-only">In Progress</span>
                </div>
                <div class="progress-bar progress-bar-danger progress-bar-striped"
                     data-toggle="NotDone" data-placement="top" title="0% Not Done"
                     style="width: 0%">
                    <span class="sr-only">Not Done</span>
                </div>
            </div>
        </div>
        <hr>
        <!-- Updates -->
        <h2 id="update"><i class="material-icons">update</i> Updates</h2>
        <div class="card card-nav-tabs">
            <div class="header header-success">
                <div class="nav-tabs-navigation">
                    <div class="nav-tabs-wrapper">
                        <ul class="nav nav-tabs" data-tabs="tabs">
                            <li class="active"><a data-toggle="tab" href="#home">Start</a></li>
                            <li><a data-toggle="tab" href="#menu1">Update 1</a></li>
                            <li><a data-toggle="tab" href="#menu2">Update 2</a></li>
                            <li><a data-toggle="tab" href="#menu3">Update 3</a></li>
                            <li><a data-toggle="tab" href="#menu4">Update 4</a></li>
                            <li><a data-toggle="tab" href="#menu5">Update 5</a></li>
                            <li><a data-toggle="tab" href="#menu6">Final Update</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="content">
                <div class="tab-content">
                    <div id="home" class="tab-pane fade in active">
                        <p>Deze week beginnen we aan het uitwerken van het schema voor het project. Eens dit af is kunnen we beginnen met het
                        bouwen van het systeem. Waarna we onze code kunnen beginnen schrijven.</p>
                    </div>
                    <div id="menu1" class="tab-pane fade">
                        <p>
                            De voorbije week heb ik mijn schema opgebouwd zonder lcd. De basis werkt en de ethernet schield krijgt zijn ip address.
                            De data die de arduino verkrijgt wordt al omgerekend voor temperatuur, voor het licht maakt dit niet zo veel uit.
                            Aan de hand van volgende foto's kan je zien hoe de huidige setup eruit ziet.<br><br>
                            <img width="100%" alt="" src="img/IMG_20161129_112537.jpg"><br><br>
                            <img width="100%" alt="" src="img/IMG_20161129_112638.jpg">
                        </p>
                    </div>
                    <div id="menu2" class="tab-pane fade">
                        <p>
                            Lcd is aangestuurd via een I2C Lcd controller. Op de Lcd kan je nu de temperatuur uitlezen en de ldr waarde.
                            Op de moment ben ik aan het uitzoeken om MQTT op mijn raspberry pi te installeren om via hier de data 
                            te kunnen wegschrijven naar een databank waarna ik deze data uitlees op een website. Het is de bedoeling om
                            van deze data een grafiek te kunnen maken over een bepaalde tijd. Evens moet de huidige waarde op de website
                            worden aangepast op constante basis, dit wordt bepaald door de arduino zelf.<br><br> 
                            <img width="100%" alt="" src="img/IMG_20161206_100412.jpg">
                        </p>
                    </div>
                    <div id="menu3" class="tab-pane fade">
                        <p>
                            MQTT is ondertussen geïnstalleerd op de Raspberry PI en vanuit de arduino wordt de data naar MQTT doorgestuurd. Op de PI staat ook een MySQL server waar de data aan de hand van een python script naartoe wordt geschreven vanuit MQTT. Voor het python script te maken heb ik gebruik gemaakt van een online gevonden <a href="https://gist.github.com/matbor/6532185" target="_blank">script</a>. Deze heb ik aangepast aan mijn normen voor mijn project. De momenteel finale code voor de arduino en mijn aangepast python script zet ik spoedig online.
                            <br><br>Ook heb ik het projectje in een "doos" kunnen inbouwen zodat ik deze makkelijker kan meenemen(zie foto). Het is nu de bedoeling om de website te beginnen opbouwen waar je de data kan bekijken en waar je constant de huidige waarde kan bekijken. Na kort onderzoek ga ik dit doen aan de hand van de databank zelf. Zo ga ik elke x aantal seconden de data ophalen vergelijken met de huidige waarde op de website en deze aanpassen indien deze gewijzigd zijn.<br><br>
                            <img width="100%" alt="" src="img/IMG_20161213_201511.jpg">
                        </p>
                    </div>
                    <div id="menu4" class="tab-pane fade">
                        <p>
                            Tijdens de eerste week van de kerst vakantie ben ik tot de ontdekking gekomen dat mijn raspberry pi waar al mijn data opstond (databank, webserver, python, mqtt broker) gecrashed is. De rasberry pi zelf werkt nog maar het kaartje dat er instak deed niets meer. Door dit voorval heb ik een snelle keuze moeten maken en heb ik gekozen om een oudere kleinere laptop te gebruiken om heel mijn linux met databank, webserver, mqtt broker, ... op te installeren. Dit heeft wel wat tijd gekost om alles terug op te bouwen. Maar na een goede dag werken was dit allemaal terug up and running.
                        </p>
                    </div>
                    <div id="menu5" class="tab-pane fade">
                        <p>
                            Na de examens die ik de komende periode had, ben ik terug begonnen aan het afwerken van mijn project. Zo heb ik mijn webapp opgebouwd. Eerst heb ik alle data laten displayen op mijn pagina om te zien of dit werkte. Hierna heb ik aan de hand van php een paar API's geschreven die van mijn data JSON bestanden maakte. Aan de hand van deze API's heb ik mijn data kunnen omzetten in grafieken. Voor de grafieken op te bouwen heb ik gebruik gemaakt van google charts linegraph. Deze werkte vlot en ziet er goed uit. Buiten de grafieken voor temperatuur en licht heb ik ook gezien dat er boven aan de pagina de laatste waarde staat die op dat moment op de arduino staat. Deze laatste waarden worden elke 5 seconden refreshed, de reden voor de 5 seconden is namelijk dat de arduino om de 10 seconden data uitstuurd naar de databank en ik deze laatste data zeker wil hebben. Hierdoor gekozen voor de 5 seconden zodat ik deze zeker niet miste.<br><br>
                            <img width="100%" alt="" src="img/website.jpg">
                        </p>
                    </div>
                    <div id="menu6" class="tab-pane fade">
                        <p>
                            Voor mijn finale update zou ik toch graag even alles willen overlopen zodat we één mooie recap hebben van alles. Voor de foto's kan je altijd terug grijpen naar de vorige updates.
                        </p>
                        <p>
                            Toen we aan dit project begonnen moesten we uiteraard eerst opzoek naar een arduino met hopelijk ook de gewenste componenten. Na even zoeken was de starterkit van arduino de goede keuze, namelijk deze had vele componenten om me te experimenteren. De website waar we de startkit kochten was kiwi-elektronics. Eens we de kit aangekregen hadden konnen we er aan beginnen. Als eerste stap had ik mijn schakeling opgebouwd met juist de ldr en temperatuur sensor, hiervoor heb ik gebruik gemaakt van de handleiding van de starterkit. En tijdens deze werk sessie heb ik ook ineens mijn ethernet shield toegevoegd zodat deze werkte. De arduino kon na afloop ook alle data omzetten naar makelijk leesbare data.
                        </p>
                        <p>
                            Tijdens de tweede sessie heb ik mijn lcd aangestuurd, dit was niet zo handig omdat ik niet wist hoe ik hier aan moest beginnen. Maar na een beetje zoekwerk en hulp van enkele collega studenten was de lcd opgezet en werkte deze zoals ik wou. Je zag de temperatuur en het licht waarde.
                        </p>
                        <p>
                            Na de lcd opgezet te hebben ben ik begonnen om MQTT op te zetten. Dit is gelukt door hulp van internet en zelf ook een beetje te tweaken tot het werkte. Voor de data om te zetten van de arduino via MQTT naar de databank heb ik gebruik gemaakt van python. Dit was namelijk da snelste en makelijkste manier. Deze fase is niet vlekkenloos verlopen. Het omzetten van de data via python naar de databank was niet makelijk. Maar na vele tweak pogingen is dit wel gelukt.
                        </p>
                        <p>
                            Na heel deze opbouw was ik zeker dat ik niet meer aan mijn arduino zou moeten komen dus ben ik opzoek gegaan hoe ik mijn project in een doosje kon steken voor properder en vooral makelijker vervoer. Ik ben terecht gekomen op een xbox doosje dat ik nog had liggen. Na enkele modificaties te doen kon ik het project hier in monteren.
                        </p>
                        <p>
                            Toen ik eenmaal wou beginnen aan het designen van mijn webapp waar je de grafieken kon bekijken en de huidige waarden kwam ik er achter dat mijn sd kaartje voor mijn raspberry pi gecrashed was. Deze bevatten namelijk al mijn data voor de webserver, databank, mqtt en python. Al een geluk had ik mijn python script nog opgeslagen op mijn computer. Door dit vooral heb ik de keuze gemaakt om een oudere laptop te gebruiken in plaats van de raspberry pi en heb ik alles terug opgezet.
                        </p>
                        <p>
                            Dan kon ik eindelijk beginnen aan mijn webapp met mijn grafieken. Na wat informatie opgezocht te hebben, kon ik op een twee dagen tijd de grafieken opzetten door eerst zelf mijn API's te schrijven en deze te gebruiken om mijn grafieken te bouwen. De grafiek technologie komt van google charts, die zeer vlot en intuitief werken. Hierna heb ik de huidige waarde nog geconfigureerd op de website zodat je deze altijd kan bekijken.
                        </p>
                        <p>
                            Na de webapp opgebouwd te hebben was het project eigenlijk afgelopen. Oef want het examen was de dag erna. Ook kan je het volledige project downloaden in een zip file. Maar door dit project te doen heb ik zelf wel veel bijgeleerd over het IOT platform. Niet alles is zo vanzelf sprekend zoals wij zouden denken. Je moet veel onderzoeken, je moeten veel verschillende technologieën gebruiken om tot 1 oplossing te komen. Wat het project bij mij heeft doen triggeren is om zeker niet te stoppen met het verder onderzoeken van het IOT platform. Heb namelijk al een idee voor een eventueel volgend project.<br><br>Alvast bedankt om mij de komende weken te volgen.<br><br>Met Vriendelijke Groeten<br>Jeroen
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <h2 id="download"><i class="material-icons">file_download</i> Download</h2>
        <div class="alert">
            <p>
                Je kan via volgende link heel het project downloaden als je hier zelf aan wil werken.<br>
                <a style="color:green;" href="project_embedded_systems_jeroen_hufkens.zip" download>project_embedded_systems.zip</a>
            </p>
        </div>
        <!-- Code -->
        
        <hr>
        <h2 id="code"><i class="material-icons">code</i> Code & Schema</h2>
        <div>
            <pre>
Arduino Code

#include &lt;PubSubClient.h&gt;
#include &lt;LiquidCrystal_I2C.h&gt;
#include &lt;SPI.h&gt;
#include &lt;Ethernet2.h&gt;

#define LDR A1
#define TEMP A0

byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };
IPAddress server(192, 168, 2, 101);
IPAddress ip(192, 168, 2, 102);
EthernetClient ethClient;
PubSubClient client(ethClient);

LiquidCrystal_I2C lcd(0x27, 2, 1, 0, 4, 5, 6, 7, 3, POSITIVE);  // Set the LCD I2C address

void setup_eth() {
  if (Ethernet.begin(mac) == 0) {
    Serial.println("Failed to configure using DHCP");
    Ethernet.begin(mac, ip); // try without DHCP:
  }
  delay(1000); // give shield time to initialize
}

void setup(){
  Serial.begin(9600);
  setup_eth();

  client.setServer(server, 1883);
  client.setCallback(callback);
  
  lcd.begin(16,2);
  for(int i = 0; i< 3; i++)
  {
    lcd.backlight();
    delay(250);
    lcd.noBacklight();
    delay(250);
  }
  lcd.backlight();
}

void loop(){
  if (!client.connected()) {
    reconnect();
  }
  client.loop();
  
  int value2 = analogRead(TEMP);
  float voltage = (value2/1024.0)*5.0;
  float temperatuur = (voltage - 0.5)*100;
  Serial.print("Temp in C: ");
  Serial.println(temperatuur);
  lcd.setCursor(0,0);
  lcd.print("Temp in C: ");
  lcd.print(temperatuur);
  int licht = analogRead(LDR);
  Serial.print("LDR: ");
  Serial.println(licht);
  lcd.setCursor(6,1);
  lcd.print("LDR: ");
  lcd.print(licht);
  lcd.print(" ");
  sentData(licht, temperatuur);
  delay(10000);
}

void callback(char* topic, byte* payload, unsigned int length) {
  Serial.print("Message arrived [");
  Serial.print(topic);
  Serial.print("] ");
  for (int i=0;i&lt;length;i++) {
    Serial.print((char)payload[i]);
  }
  Serial.println();
}

void reconnect() {
  // Loop until we're reconnected
  while (!client.connected()) {
    Serial.print("Attempting MQTT connection...");
    // Attempt to connect
    if (client.connect("arduinoClient")) {
      Serial.println("connected");
      // Once connected, publish an announcement...
      client.publish("outTopic","hello world");
      // ... and resubscribe
      client.subscribe("inTopic");
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" try again in 5 seconds");
      // Wait 5 seconds before retrying
      delay(5000);
    }
  }
}

void sentData(int ldr, float tempa){
  String s1 = "T";
  String s2 = String(tempa);
  String s3 = "L";
  String s4 = String(ldr);
  String comb = String(s1 + s2 + s3 + s4);
  client.publish("outTopic",comb.c_str());
  client.subscribe("inTopic");
}


Python Conf + Script

{
 "debug"           : 0,
 "broker"          : "localhost",
 "broker_port"     : 1883,
 "broker_username" : "",
 "broker_password" : "",
 "broker_clientid" : "arduino_MQTT_sql",
 "mysql_server"    : "localhost",
 "mysql_username"  : "root",
 "mysql_passwd"    : "azerty",
 "mysql_db"        : "mqtt",
 "mysql_table"     : "arduino"
}

#!/usr/bin/python

import MySQLdb
import paho.mqtt.client as mosquitto
import json
import time

config = json.load(open('./myscript.conf'))

broker_topic = 'outTopic'

# Open database connection
db = MySQLdb.connect(config['mysql_server'], config['mysql_username'],
config['mysql_passwd'], config['mysql_db'])
# prepare a cursor object using cursor() method
cursor = db.cursor()

def on_connect(mosq, obj, rc):
    if config['debug']: print("rc: "+str(rc))

def on_message(mosq, obj, msg):
    if config['debug']: print(msg.topic+" "+str(msg.qos)+" "+str(msg.payload))

    try:
       # Execute the SQL command
       # change locations to the table you are using
       queryText = "INSERT INTO %s VALUES (now(),%r);"
       queryArgs = ( tuple([ config['mysql_table'], MySQLdb.escape_string(msg.payload) ]))
       cursor.execute(queryText % queryArgs)
       if config['debug']: print('Successfully Added record to mysql')
       db.commit()
    except MySQLdb.Error, e:
        try:
            print "MySQL Error [%d]: %s" % (e.args[0], e.args[1])
        except IndexError:
            print "MySQL Error: %s" % str(e)
        # Rollback in case there is any error
        db.rollback()
        print('ERROR adding record to MYSQL')

def on_publish(mosq, obj, mid):
    print("mid: "+str(mid))

def on_subscribe(mosq, obj, mid, granted_qos):
    if config['debug']: print("Subscribed: "+str(mid)+" "+str(granted_qos))

def on_log(mosq, obj, level, string):
    if config['debug']: print(string)

mqttc = mosquitto.Mosquitto(config['broker_clientid'], clean_session=True )
mqttc.on_message = on_message
mqttc.on_connect = on_connect
mqttc.on_publish = on_publish
mqttc.on_subscribe = on_subscribe

# Uncomment to enable config['debug'] messages
mqttc.on_log = on_log

mqttc.username_pw_set(config['broker_username'], password = config['broker_password'])

mqttc.connect(config['broker'], config['broker_port'], 60)
mqttc.subscribe(broker_topic, 0)

rc = 0
while rc == 0:
    rc = mqttc.loop()

if config['debug']: print("rc: "+str(rc))

# disconnect from server
print ('Disconnected, done.')
db.close()


<img alt="" src="img/Schema_V0.png">
            </pre>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="vertical-center">
            <p style="padding-top:1em;">Design & Copyright Jeroen - Powered By: Arduino</p>
        </div>
    </footer>
</body>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js">
</script>
<script src="js/bootstrap.js"></script>
<script src="js/default.js"></script>
<script src="js/jquery.backstretch.min.js"></script>
    
<script src="js/material.min.js"></script>
<script src="js/nouislider.min.js" type="text/javascript"></script>
<script src="js/bootstrap-datepicker.js" type="text/javascript"></script>
<script src="js/material-kit.js" type="text/javascript"></script>
    
<script>
    $().ready(function(){
        $(window).on('scroll', materialKit.checkScrollForTransparentNavbar);
    });
    $('[data-toggle="Complete"]').tooltip();
    $('[data-toggle="InProgress"]').tooltip();
    $('[data-toggle="NotDone"]').tooltip();
</script>

</html>
